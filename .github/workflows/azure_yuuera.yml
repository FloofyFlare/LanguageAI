# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - Yuuera

on:
  push:
    branches:
      - azure
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: npm install, build, and test
        run: |
          npm install
          npm run build --if-present
          npm run test --if-present

      - name: Zip artifact for deployment
        run: zip release.zip ./* -r

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: release.zip
        env:
          NUXT_GOOGLE: AIzaSyBZsuGsClndCNnyzUQ3oXY9cRAGj3LGV8M
          NUXT_DEEP_INFRA: tLaH0JrTds3DNRuksfmjdb9TSgwM1Z36
          NUXT_AZURE_ENDPOINT: https://yuuera.openai.azure.com/
          SUPABASE_URL: https://kmsqiywjsqoxwctpvkqv.supabase.co
          SUPABASE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imttc3FpeXdqc3FveHdjdHB2a3F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjIzODI3NzgsImV4cCI6MjAzNzk1ODc3OH0.ileLTKVXznu3FLFWbhs9emHlcjSCxGxbtybSB3RiEq8
          NUXT_AZURE_CLIENT: 36a942fb-f7e8-4862-82e4-3c7f655d4d2c
          NUXT_AZURE_TENANT: cdeece57-68b3-4625-ba3e-d1e37f9f6d6c
          NUXT_AZURE_SECRET: 46M8Q~RpT2Q2uX9PLMxf6xiB.SnHmLjEqB4rka5s
          NUXT_AZURE_KEY: 79S96ShlEgH4vq1PTqJANxo6M4BqQQ5vPDte95kE7icwNvzb6242JQQJ99ALACYeBjFXJ3w3AAABACOGI65S
          
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write #This is required for requesting the JWT

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Unzip artifact for deployment
        run: unzip release.zip
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_D16FAD86281A44C6A6793AA056F69D92 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_E8D91531AA2F47C98B1B088B9D0689B4 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_B08C65618C0041C9A1F27AA0026EB628 }}

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'Yuuera'
          slot-name: 'Production'
          package: .
          
